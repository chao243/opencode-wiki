# OpenCode æ ¸å¿ƒé€»è¾‘æ¶æ„åˆ†æ

## ğŸ¯ æ ¸å¿ƒé€»è¾‘æ¶æ„

### 1. Session ç¼–æ’ä¸æ¶ˆæ¯å¤„ç† â­â­â­â­

**ä½ç½®**: `packages/opencode/src/session/`

**å…³é”®æ–‡ä»¶ï¼š**

- **`prompt.ts`** (53KB) - **ä¸»è¦ç¼–æ’å¾ªç¯**ã€‚è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼š
  - ä¸» `loop()` å‡½æ•°é©±åŠ¨æ•´ä¸ªå¯¹è¯æµç¨‹
  - å¤„ç†ç”¨æˆ·æç¤ºï¼Œåˆ›å»ºæ¶ˆæ¯
  - ç®¡ç†å­ä»»åŠ¡ã€å‹ç¼©å’Œæ­£å¸¸å¤„ç†
  - è§£æå¹¶æ‰§è¡Œå·¥å…·ï¼ˆå†…éƒ¨å·¥å…·ã€MCPã€å­ä»£ç†ï¼‰
  - é€šè¿‡ `@agent` è¯­æ³•å¤„ç†ä»£ç†åˆ‡æ¢

- **`processor.ts`** (15KB) - **æµå¤„ç†å¼•æ“**ï¼š
  - å®æ—¶å¤„ç† LLM å“åº”æµ
  - å¤„ç†å·¥å…·è°ƒç”¨ã€æ¨ç†ã€æ–‡æœ¬éƒ¨åˆ†
  - ç®¡ç†å·¥å…·æ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼ˆpending â†’ running â†’ completed/errorï¼‰
  - æ£€æµ‹å¹¶é˜²æ­¢æ­»å¾ªç¯
  - éšç€æµåˆ°è¾¾é€æ­¥æ›´æ–°æ¶ˆæ¯éƒ¨åˆ†

- **`llm.ts`** (7KB) - **LLM é›†æˆå±‚**ï¼š
  - å°è£… AI SDK çš„ `streamText()`
  - ç®¡ç†ç³»ç»Ÿæç¤ºå’Œå·¥å…·è§£æ
  - å¤„ç†æ¨¡å‹ç‰¹å®šçš„è½¬æ¢
  - ä¸æä¾›è€…é€‰é¡¹å’ŒåŠŸèƒ½é›†æˆ

- **`index.ts`** (14KB) - **Session çŠ¶æ€ç®¡ç†**ï¼š
  - Session CRUD æ“ä½œ
  - æ¶ˆæ¯/éƒ¨åˆ†æŒä¹…åŒ–
  - ä½¿ç”¨è·Ÿè¸ªå’Œæˆæœ¬è®¡ç®—
  - Session å…±äº«å’Œåˆ†å‰

### 2. Agent ç³»ç»Ÿ â­â­â­â­

**ä½ç½®**: `packages/opencode/src/agent/agent.ts` (11KB)

**æ ¸å¿ƒèŒè´£ï¼š**

- Agent æ³¨å†Œè¡¨ï¼ŒåŒ…å«å†…ç½®ä»£ç†ï¼š**build**ã€**plan**ã€**general**ã€**explore**ã€**compaction**ã€**title**ã€**summary**
- Agent é…ç½®ï¼ˆæƒé™ã€æ¨¡å‹ã€æç¤ºè¯ã€é€‰é¡¹ï¼‰
- é€šè¿‡ LLM ç”Ÿæˆ Agent
- æƒé™ç³»ç»Ÿé›†æˆ

### 3. å·¥å…·æ‰§è¡Œç³»ç»Ÿ â­â­â­

**ä½ç½®**: `packages/opencode/src/tool/`

**æ ¸å¿ƒç»„ä»¶ï¼š**

- **`tool.ts`** - å·¥å…·å®šä¹‰æ¡†æ¶ï¼Œä½¿ç”¨ `Tool.define()` æ¨¡å¼
- **`registry.ts`** - å·¥å…·å‘ç°å’Œæ³¨å†Œ
- **30+ å·¥å…·å®ç°**ï¼šreadã€grepã€globã€editã€writeã€bashã€patchã€lsp ç­‰
- æ¯ä¸ªå·¥å…·ï¼šéªŒè¯è¾“å…¥ã€æ‰§è¡Œã€è¿”å›æ ¼å¼åŒ–è¾“å‡º
- å¤§ç»“æœè‡ªåŠ¨æˆªæ–­

### 4. æƒé™ç³»ç»Ÿ â­â­â­

**ä½ç½®**: `packages/opencode/src/permission/next.ts`

**æœºåˆ¶ï¼š**

- åŸºäºè§„åˆ™é›†çš„æƒé™è¯„ä¼°ï¼ˆallow/deny/askï¼‰
- `PermissionNext.ask()` - è§¦å‘ç”¨æˆ·æƒé™æç¤º
- `PermissionNext.evaluate()` - ç¡®å®šå·¥å…·/ä»£ç†ä½¿ç”¨çš„åŠ¨ä½œ
- "Always" æ‰¹å‡†ç¼“å­˜
- ä¸ session å’Œ agent æƒé™é›†æˆ

### 5. å­˜å‚¨å±‚ â­â­

**ä½ç½®**: `packages/opencode/src/storage/storage.ts`

**å®ç°ï¼š**

- åŸºäº JSON æ–‡ä»¶çš„å­˜å‚¨ï¼ˆ`~/.opencode/storage/`ï¼‰
- `read()`ã€`write()`ã€`update()`ã€`remove()`ã€`list()` æ“ä½œ
- å¹¶å‘è®¿é—®çš„æ–‡ä»¶é”å®š
- æ¨¡å¼å‡çº§çš„è¿ç§»ç³»ç»Ÿ
- å­˜å‚¨ç»“æ„ï¼šsessionsã€messagesã€partsã€permissionsã€projects

### 6. Provider/æ¨¡å‹ç®¡ç† â­â­

**ä½ç½®**: `packages/opencode/src/provider/provider.ts` (40KB)

**èƒ½åŠ›ï¼š**

- å¤šæä¾›è€…æ”¯æŒï¼šAnthropicã€OpenAIã€Googleã€AWS Bedrockã€Azureã€xAIã€Groqã€Mistral ç­‰
- æ¨¡å‹å‘ç°å’Œé…ç½®
- èº«ä»½éªŒè¯å¤„ç†
- æ¨¡å‹ç‰¹å®šçš„å‚æ•°è½¬æ¢
- è‡ªå®šä¹‰æä¾›è€…åŠ è½½

### 7. MCP (Model Context Protocol) â­â­

**ä½ç½®**: `packages/opencode/src/mcp/index.ts` (26KB)

**é›†æˆï¼š**

- MCP å®¢æˆ·ç«¯ç®¡ç†ï¼ˆstdioã€SSEã€HTTP ä¼ è¾“ï¼‰
- è¿œç¨‹æœåŠ¡å™¨çš„ OAuth è®¤è¯æµç¨‹
- ä» MCP æœåŠ¡å™¨æš´éœ²å·¥å…·
- èµ„æºå’Œæç¤ºé›†æˆ
- åŠ¨æ€å·¥å…·æ³¨å†Œ

## ğŸ”„ ä¸»è¦æ•°æ®æµ

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
SessionPrompt.loop() [prompt.ts]
  â†“
resolveTools() â†’ ToolRegistry + MCP + å†…éƒ¨å·¥å…·
  â†“
LLM.stream() [llm.ts]
  â†“
SessionProcessor.process() [processor.ts]
  â†“
å·¥å…·æ‰§è¡Œ â†’ PermissionNext.ask() â†’ Tool.execute()
  â†“
Storage å†™å…¥ [storage.ts]
  â†“
æ¶ˆæ¯/éƒ¨åˆ†æ›´æ–° â†’ Bus äº‹ä»¶
```

## ğŸ¯ æ€»ç»“ï¼šOpenCode çš„"å¿ƒè„"

**æœ€å…³é”®çš„é€»è¾‘ä½äºï¼š**

1. **`src/session/prompt.ts`** - ä¸»è¦ç¼–æ’å’Œå·¥å…·è·¯ç”±
2. **`src/session/processor.ts`** - æµå¤„ç†å’Œå·¥å…·æ‰§è¡Œ
3. **`src/session/index.ts`** - çŠ¶æ€ç®¡ç†
4. **`src/agent/agent.ts`** - Agent ç³»ç»Ÿ
5. **`src/tool/registry.ts`** - å·¥å…·å‘ç°
6. **`src/permission/next.ts`** - å®‰å…¨/è®¿é—®æ§åˆ¶
7. **`src/storage/storage.ts`** - æŒä¹…åŒ–å±‚

è¿™äº›æ–‡ä»¶ååŒå·¥ä½œï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ™ºèƒ½çš„ AI ç¼–ç åŠ©æ‰‹ï¼Œå…·å¤‡å¤šä»£ç†èƒ½åŠ›ã€å·¥å…·æ‰§è¡Œã€æƒé™ç®¡ç†å’ŒæŒä¹…åŒ–å­˜å‚¨ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
packages/opencode/src/
â”œâ”€â”€ session/          # Session ç®¡ç†å’Œç¼–æ’
â”‚   â”œâ”€â”€ prompt.ts      # ä¸»ç¼–æ’å¾ªç¯ â­â­â­â­
â”‚   â”œâ”€â”€ processor.ts   # æµå¤„ç†å¼•æ“ â­â­â­â­
â”‚   â”œâ”€â”€ llm.ts        # LLM é›†æˆ â­â­â­
â”‚   â”œâ”€â”€ index.ts      # Session çŠ¶æ€ç®¡ç† â­â­â­
â”‚   â””â”€â”€ message-v2.ts # æ¶ˆæ¯æ•°æ®æ¨¡å‹
â”œâ”€â”€ agent/            # Agent ç³»ç»Ÿ
â”‚   â””â”€â”€ agent.ts      # Agent æ³¨å†Œå’Œé…ç½® â­â­â­â­
â”œâ”€â”€ tool/             # å·¥å…·ç³»ç»Ÿ
â”‚   â”œâ”€â”€ tool.ts       # å·¥å…·å®šä¹‰æ¡†æ¶
â”‚   â”œâ”€â”€ registry.ts   # å·¥å…·å‘ç°å’Œæ³¨å†Œ â­â­â­
â”‚   â””â”€â”€ [30+ tools] # å·¥å…·å®ç°
â”œâ”€â”€ permission/        # æƒé™ç³»ç»Ÿ
â”‚   â””â”€â”€ next.ts      # æƒé™è¯„ä¼°å’Œæ‰§è¡Œ â­â­â­
â”œâ”€â”€ storage/          # å­˜å‚¨å±‚
â”‚   â””â”€â”€ storage.ts    # æŒä¹…åŒ–å®ç° â­â­
â”œâ”€â”€ provider/         # æ¨¡å‹æä¾›è€…
â”‚   â””â”€â”€ provider.ts   # å¤šæä¾›è€…ç®¡ç† â­â­
â”œâ”€â”€ mcp/              # MCP é›†æˆ
â”‚   â””â”€â”€ index.ts      # MCP å®¢æˆ·ç«¯ç®¡ç† â­â­
â””â”€â”€ [å…¶ä»–æ ¸å¿ƒæ¨¡å—]
```

## ğŸ”‘ å…³é”®æ¦‚å¿µ

### Sessionï¼ˆä¼šè¯ï¼‰

- è¡¨ç¤ºä¸ AI ä»£ç†çš„å¯¹è¯
- åŒ…å«æ¶ˆæ¯åˆ—è¡¨ã€å…ƒæ•°æ®ã€æƒé™è§„åˆ™
- æ”¯æŒåˆ†å‰ï¼ˆåˆ›å»ºå­ä¼šè¯ï¼‰
- å¯å…±äº«ï¼ˆé€šè¿‡ URL åˆ†äº«ä¼šè¯ï¼‰

### Agentï¼ˆä»£ç†ï¼‰

- å…·æœ‰ç‰¹å®šèƒ½åŠ›å’Œæƒé™çš„ AI å®ä½“
- å†…ç½®ï¼šbuildï¼ˆæ„å»ºï¼‰ã€planï¼ˆè®¡åˆ’ï¼‰ã€generalï¼ˆé€šç”¨ï¼‰ã€exploreï¼ˆæ¢ç´¢ï¼‰
- å¯è‡ªå®šä¹‰ï¼šé€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºæ–°ä»£ç†
- æ”¯æŒä»£ç†åˆ‡æ¢ï¼ˆä½¿ç”¨ `@agent` è¯­æ³•ï¼‰

### Toolï¼ˆå·¥å…·ï¼‰

- AI ä»£ç†å¯æ‰§è¡Œçš„æ“ä½œ
- åˆ†ç±»ï¼šæ–‡ä»¶æ“ä½œï¼ˆread/write/editï¼‰ã€æœç´¢ï¼ˆgrep/globï¼‰ã€æ‰§è¡Œï¼ˆbashï¼‰ã€LSP ç­‰
- åŠ¨æ€åŠ è½½ï¼šä»æ³¨å†Œè¡¨ã€MCP æœåŠ¡å™¨ã€æ’ä»¶
- æƒé™æ§åˆ¶ï¼šæ¯ä¸ªå·¥å…·éƒ½æœ‰æƒé™è§„åˆ™

### Permissionï¼ˆæƒé™ï¼‰

- è§„åˆ™é›†é©±åŠ¨çš„è®¿é—®æ§åˆ¶ç³»ç»Ÿ
- åŠ¨ä½œï¼šallowï¼ˆå…è®¸ï¼‰ã€denyï¼ˆæ‹’ç»ï¼‰ã€askï¼ˆè¯¢é—®ï¼‰
- æ”¯æŒæ¨¡å¼åŒ¹é…ï¼ˆé€šé…ç¬¦ï¼‰
- ç¼“å­˜ç”¨æˆ·æ‰¹å‡†ï¼ˆ"always" é€‰é¡¹ï¼‰

### Messageï¼ˆæ¶ˆæ¯ï¼‰

- å¯¹è¯çš„åŸºæœ¬å•ä½
- åŒ…å«å¤šä¸ªéƒ¨åˆ†ï¼ˆæ–‡æœ¬ã€å·¥å…·è°ƒç”¨ã€æ–‡ä»¶ã€æ¨ç†ç­‰ï¼‰
- æ”¯æŒæµå¼æ›´æ–°ï¼ˆå¢é‡ï¼‰
- ä¸æˆæœ¬å’Œ token ä½¿ç”¨è·Ÿè¸ªå…³è”

## ğŸš€ æ‰©å±•ç‚¹

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `packages/opencode/src/tool/` åˆ›å»ºæ–°æ–‡ä»¶
2. ä½¿ç”¨ `Tool.define()` å®šä¹‰å·¥å…·
3. å®ç°å‚æ•°éªŒè¯ï¼ˆZod schemaï¼‰
4. å®ç°æ‰§è¡Œé€»è¾‘
5. è¿”å›æ ¼å¼åŒ–è¾“å‡º

### æ·»åŠ æ–° Agent

1. ç¼–è¾‘ `~/.opencode/config.json`
2. åœ¨ `agent` éƒ¨åˆ†å®šä¹‰æ–°ä»£ç†
3. é…ç½®æƒé™ã€æ¨¡å‹ã€æç¤ºè¯
4. è®¾ç½®é€‰é¡¹ï¼ˆtemperatureã€topP ç­‰ï¼‰

### æ·»åŠ æ–° Provider

1. åœ¨ `packages/opencode/src/provider/provider.ts` æ³¨å†Œ
2. æä¾›åˆ›å»ºå‡½æ•°
3. å®šä¹‰æ¨¡å‹åˆ—è¡¨å’Œæˆæœ¬
4. å®ç°èº«ä»½éªŒè¯ï¼ˆå¦‚éœ€è¦ï¼‰

### é›†æˆ MCP æœåŠ¡å™¨

1. åœ¨ `~/.opencode/config.json` é…ç½® MCP
2. æŒ‡å®šæœåŠ¡å™¨ç±»å‹ï¼ˆstdio/remote/SSEï¼‰
3. é…ç½® OAuthï¼ˆå¦‚éœ€è¦ï¼‰
4. è‡ªåŠ¨æš´éœ²å·¥å…·å’Œèµ„æº

---

_ç”Ÿæˆæ—¶é—´: 2026-01-08_
_OpenCode ç‰ˆæœ¬: dev_
